# 이제는 더 이상 물러날 곳이 없다! Graviton 프로세서와 Karpenter로 극한까지 Amazon EKS 비용 최적화

{% file src="../../../.gitbook/assets/발표자료_이제는_더_이상_물러날_곳이_없다!_Graviton_프로세서와_Karpenter로_극한까지_Amazon_EKS_비용_최적화.pdf" %}

쿠버네티스 당면 비용 과제

1. 팀과 부서간 비용 할당
2. chargeback/showback
3. 리포팅, 예산예측, 비용최적화

\-

비용 통제가 어려움...

\-

주 비용은 주로 4가지

\-

그라비톤 비용 최적화

\-.-.-

그라비톤은 arm cpu 에서 문제없이 동작해야 함

\-> 사용하는 앱이 멀티 아키텍처 이미지를 적용시켜야 함

\-

대표적으로 삼성전자가 그라비톤을 사용하여 15% 비용 절감

arm 기반 프로세서 트렌드 확보 또한 중요하다고 함...

\-

카펜터 비용 최적화

\-

gitops... 가 뭐지...

\-

비용 절감 : 프로비저닝을 적절히 하여 비용 절감

사용율이 적은 pod 를 통합함으로서 consolidation 기능으로 추가 절감 가능

\-

카펜터는 provisioner 이라는 커스텀 리소스를 통해 프로비저닝하고자 하는 인스턴스 타입이나 옵션을 정하여 노드를 자동적으로 설정하여 처리 가능

\-

consolidation :&#x20;

리소스 사용 증가로  스케일아웃된 이후 pod 종료되었음에도 불구하고 노드가 스케일인하지 못하는 현상이 있음

카펜터 옵션을 통해 자원 활용률이 낮은 노드를 bin packing 을 통해 비용 절감 가능

\-

콘솔리데이션 기능 동작 방식...

콘솔리데이션 폴 대기

대상이 될 노드 식별

1. Provisioner custom resource definition 에 의해 구동된 노드인지를 확인
2. do-not-consolidate 어노테이션인지 아닌지 확인
   1. 보다 조심스러운 워커로드인 경우, consolidation 이 일어나지 않도록 설정 가능
3. reposts ready + 확장 리소스 등록이 된 노드가 consolidation 처리됨
4. disruption cost : 중단 비용을 기준으로 정렬
   1. 노드에 스케줄이 많이 되어있는 경우에는 node 를 함부로 종료시키지 않도록 함 = 중단 비용 높음
   2. 중단 비용 계산 ? = 노드 TTL 개념을 도입함
   3. pod-deletion-cost 개념 : 삭제될 경우 큰 영향이 있는 경우 이런 어노테이션을 넣어놓음
5. 최저 중단 비용을 삭제한 경우에 대해 시뮬레이션 하고, 처리함

더 저렴한 노드를 실행 가능하다면 pod를 옮겨서 실행하도록 함

\-

카펜터의 consolidation 을 provisoner 라는 커스텀 리소스에 정의하여 손쉽게 사용 가능

개발 클러스터와 같은 클러스터는 spot 인스턴스로만 구성하여 처리 가능

이 경우, 애플리케이션이 스테이트리스.... + 다양한 인스턴스 타입 구성

카펜터의 spot interruption handling 기능 활용하여 spot 인스턴스가 문제 없도록 처리해야 함

예시의 경우, amd64 + arm 형태로 구성하여 비용 최적화 꾀함

가드레일 방식으로 provisioner 를 구성할 수도 있음

\-

무신사의 경우 클러스터 오토스케일러로 처리했지만, 카펜터를 이용함으로서 더 좋게 처리 가능

오버 프로비저닝 하던것을 인스턴스를 좀 더 최적화함

\-





